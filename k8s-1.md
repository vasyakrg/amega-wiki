---
title: Свой k8s - ШАГ 1
description: Минимум, что бы поднять свой k8s на коленке
published: true
date: 2019-12-30T08:11:08.258Z
tags: 
---

# Шаг 1
Подготавливаем железо для будущего эксперимента, используя быстрый [Hetzner Cloud](https://console.hetzner.cloud/)

>Регистрация и создание нод под весь проект
{.is-success}


Для начала, надо зарегистрироваться на [Hetzner Cloud](https://console.hetzner.cloud/) и создать пустой проект.
Кредитную карту они не просят навязчиво, как другие облачные провайдеры. У меня недавно в биллинг обнаружился счет двух месячной давности, который я забыл оплатить - при этом, все работало и никто ничего не отключал. Достаточно лояльные ребята.
Можно кстати подвязать свой PayPal и вообще не светить данные карты (для ребят с шапочкой из фольги), а так же прикрутить 2FA (рекомендую)

Создаем тестовый проект и идет в создание серверов. 

>Поднимаем будущее хранилище
{.is-success}

Нам нужны три одинаковых сервера. Выбираем самый дешевый CX11 за 2.49  в месяц, выбираем ОС Ubuntu-1804, прикручиваем сразу свой ssh-ключ, что бы потом не было мороки с доступом. Задаем имя node-1. 
В поле кол-во серверов - ставим 3. Все остальное пока оставляем как есть. Нажимаем Create & Bay now.

> Ребята гордятся тем, что ноды создаются в течение 10 секунд - магия, блин :)
> 
Теперь идем в раздел Volumes, создаем 3 волума по 10Гб каждый (больше нам не надо, данные мы все равно хранить так не будем). При создании каждого волума желательно задавать ему номер соответствующий ноде, к которой вы его цепляете. Туту же выбираем куда цеплять и оставляем EXT4 систему по умолчанию. Пока на все это не очень важно.

По итогу: имеет 3 ноды node1\2\3 и три подключенных к ним волума volume-1\2\3

>Поднимаем ноды для rancher кластера
{.is-success}

Оговорюсь, что в тесте мы будем использовать 3 ноды, на которых будем хранить все данные и службы кластера.

Таким же макаром создаем три ноды, выбирая тариф **CX-21**, а ОС так же **Ubuntu-1804**. Волумы там не нужны, ssh-key не забудьте прикрепить свой. Именуем их как k8s-1\2\3 соотвественно.

> Если после создания серверов вам на почту пришло письмо с паролем, то вы забыли прикрепить ssh-key. Удалить такой сервер (а если он с подключенным волумом, но сначала удалите волум) и пересоздайте снова. Проблем будет меньше.
{.is-info}

По итогу: имеем 3 ноды с волумами по 10Гб для будущего хранилища Ceph, 3 ноды для кластера k8s с rancher

---
>Запускаем rancher
{.is-success}

Для начала нам надо на всех k8s-n нодах получить рабочий docker. Есть масса вариантов, от банальной `apt  install docker.io`, когда на выходе вы получите старую 18.09 версию, до [маунала](https://www.linode.com/docs/applications/containers/install-docker-ce-ubuntu-1804/), коих много и все как один. Используйте его, а можно прокатить моим [ansible-скриптом](https://github.com/vasyakrg/docker_install), он даст больше возможностей при начальной установке
Получив docker на нодах, продолжим.

Идем на первую ножу k8s-1 по shh

> `ssh root@ip` - где ip можно подсмотреть в веб-консоли Hetzner

запускаем установку rancher, внешний порт 8443 я прописываю намеренно, т.к. у нас все системы и службы будут на одних и тех же нодах (так же будет и nginx балансер, котому как раз будут нужны 80 и 443 порты).
> `docker run -d --name rancher-1 --restart=unless-stopped -p 8443:443 rancher/rancher`

идем в панель управления и далее все делаем там
> `https://<ip k8s-1>:8443/`

> Создаем кластер
{.is-success}


Придумываем пароль, сохраяем урл по айпи-адресу (помним, что все это просто тестовое окружение).
Идем в раздел `Clusters` и жмем `Add cluster`. Выбираем `From exiting nodes (Custom)`.
На следующей странице начинаем минимально заполнять данные:

- имя кластара - `k8s-test`

и больше на этой страницы ничего не трогаем, жмем `Next`.

> Следующая страница крайне важна и тут надо быть осторожным, что бы потом снова все не переделывать.
**НЕ** нажимайте **Done**!
{.is-warning}

Для начала выбираем все три галочки `etcd`, `Control Plane`, `Workers`
Далее прописываем в поле external ip - **внешний адрес** первой ноды k8s-1 (мы ранее заходили по нему по ssh).
Чуть ниже прописываем имя ноды - **k8s-1**

По мере заполнения полей, ниже в пункте для будет меняться строка (прям простыня) для запуска на ноде.
По завершению заполнения, справа от строки ждем синюю кнопку копирования в буфер и идем на ноду по ssh, вставляем и запускаем скопированный тест.

На ноде подкачаются нужные образы, запустится агент rancher, а у вас на странице снизу под кодом будет написано `1 new node has registered`

> кнопку Done - НЕ жмем!
{.is-warning}

На этой же странице меняем айпишник на **адрес** второй ноды k8s-2, а имя ноды соответствено на **k8s-2**, снова копируем код снизу и идем уже на **вторую** ноду k8s-2 по ssh. Копируем текст туда и запускаем.
Снова видим надпись `2 new nodes have registered`

Ну и как вы догадались - все тоже самое проделываем с нодой **k8s-3**, дожидаемся записи `3 new nodes have registered` и наконец-то **нажимаем** заветное `Done`.

Откидываемся на спинку кресла и ожидаем завершения инициализации нашего тестового кластера (занимает обычно минут 5-7)

По завершению развертывания, фактически уже сейчас вы имеете вполне себе рабочий кластер (мы помним, что это тест и ни о какой отказоустойчивости мы не говорим).






