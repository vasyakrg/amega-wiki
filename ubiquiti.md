---
title: Ubiquiti - починка cloudkey
description: Как починить cloudkey в связке с роутером и прописать правильные хосты
published: false
date: 2022-04-08T06:06:28.945Z
tags: cloudkey, ubiquiti
editor: markdown
dateCreated: 2020-03-08T03:40:49.789Z
---

# Болезнь

Не получается зайти на 150.9 (manager), пользователи жалуются коворку что не работают ваучеры. 

# Осмотр

Приходим на коворк никого не слушая, идем в серверную.
С собой надо иметь Ethernet hub  и ноутбук
Видим за первым шкафом 

Шлюз
![шлюз.png](/шлюз.png)

Cloudkey
![keyy.png](/keyy.png)

PoE-блок
![poe.png](/poe.png)


# Лечение

- Берем скрепку и сбрасываем обе железки ( имеются ПОДПИСАННЫЕ кнопки «reset» )
- Выдергиваем WAN и LAN из Шлюза 
- Выдергиваем LAN из POE блока
- Объединяем LAN Шлюза и Lan Cloud Key в hub

Тут мы видим, что: Lan Шлюза, ноутбук, Cloud Key подключены в  hub.
![общ_сис.png](/общ_сис.png)

# Cтавим софт

> Качаем программу с сайта
{.is-success}

https://www.ui.com/download/unifi 
![ссыль_проги.png](/ссыль_проги.png)

> Скачали. Поставили. Заходим. 
{.is-success}

Если всё сбросили и подключили правильно, то видим окно с активной кнопкой. 
![кнопка.png](/кнопка.png)


При подключении все получают `1-ю` сетку.
Заходим на `192.168.1.1` (Шлюз) видим список устройств. 

После того как нашли наш Cloud Key надо зайти в менеджер и видим 
![настр.png](/настр.png)

Нажимаем `восстановить из предыдущей резервной копии` и выбираем с ноута бэкап старой система, которая работала. Ждем минут 5-12 пока встанет. 

> Заходим на восстановленное железо. 
{.is-success}

Заходим на шлюз. Заполняем поля WAN с файлика в профиле коворка
![wan_с_файлика.png](/wan_с_файлика.png)

# Настройка WAN

- убираем DHCP во вкладке LAN прописываем сеть 150.1 
- Подключаем Шлюз и cloud key обратно в систему. 
- Ждем пока всё поднимается. после того всё поднимется проверяем в 150.9 в менеджере. 

после чего идем в SSH и крутим настройки для выхода окна ввода ваучера


# Настройка SSH

командная строка
`ssh admin@192.168.150.1` (логин задается каждый раз после сброса)
pass `Tp9JACMvTeaCgi67` (задается каждый раз после сброса)
`cat /etc/hosts` - посмотреть файл
`sudo vi /etc/hosts` - открывает файл в редакторе vi (гореть им в аду)

чтобы перейти в режим редактирования жмем `i`
прописываем необходимые данные, например `192.168.150.9	wifi.iqwork.me wifi.iqwork.kz`
для завершения редактирования жмем `ESC`
команды в редакторе:
`:w` - записать в файл 
`:wq` - записать и выйти
`:q!` - выйти, без сохранения

`cat /etc/hosts` - проверяем, выводит на эран содержимое

`sudo /opt/vyatta/bin/sudo-users/vyatta-op-dns-forwarding.pl --clear-cache` чистит кэш DNS

# Настройка сертификата для гостевого портала

Нужно:
- получить сам серт у Васи (три файла: crt, key, ca)
- иметь доступ на сам ssh у клауда (150.9)

Делаем:
- идем на ssh login@ip_cloud
- ставим редактор nano, что бы не иметь секас с vi:
	- качаем редактор `wget http://ftp.us.debian.org/debian/pool/main/n/nano/nano-tiny_2.2.6-3_armhf.deb`
  - ставим `dpkg -i nano-tiny_2.2.6-3_armhf.deb`
- `nano crt` - создает файл `crt`, туда помещаем содержимое файла `crt`, полученного у Васи
- `nano key` - создает файл `key`, туда помещаем содержимое файла `key`, полученного у Васи
- `nano ca` - создает файл `ca`, туда помещаем содержимое файла `ca`, полученного у Васи
- запускаем сборку закрытого серта p12 из того, что создали - `sudo openssl pkcs12 -export -in crt -inkey key -out cloudkey.p12 -name unifi -CAfile ca -caname root -password pass:aircontrolenterprise` - запускаем как есть, ничего не меняя.
- запускаем импорт серта в хранилище сертификатов `sudo keytool -importkeystore -deststorepass aircontrolenterprise -destkeypass aircontrolenterprise -destkeystore /usr/lib/unifi/data/keystore -srckeystore cloudkey.p12 -srcstoretype PKCS12 -srcstorepass aircontrolenterprise -alias unifi`
- задаем (восстанавливаем по сути) права на папки с сертами - `chown root:ssl-cert /etc/ssl/private/* && chmod 640 /etc/ssl/private/*`
- перезапускает службы (долго, минуты 2-3) - `/etc/init.d/nginx restart ; /etc/init.d/unifi restart`
- радуемся сертификату до первого сброса\обновления клауда прошивкой или софтом или до завершения срока протухания серта (дается на 1 год, первый раз выпустили 09 декабря 2020 года)

Комменты:
- если сборка серта p12 ломается, обычно это из-за кривого копирования текста в файлы. бывает сроки ломаются и\или переносы строк.
файлы должны выглядеть как и оригинали после их сохранения (`cat key`)
- этими командами можно проверить статусы сервисов и понять, что сломалось и почему не запускается (НЕ надо сразу скрепкой херить прошивку на заводские!):
```
/etc/init.d/nginx status
/etc/init.d/unifi status
```

- если пишет, что команды `keytool` нет и он не знает, что делать, значит вы, как и я первый раз, зашли на `150.1 (роутер)`, а не на `150.9 (клауд)`, и в пустую потратили пол часа.

# Софт для выдачи сертов

Что бы он работал, нужны два условия:
- рабочий `клауд (150.9)` - с этим ипом и логопасом, который wifiadmin и не менялся
- рабочий сервис докера `151.50` (должна открываться страница `http://192.168.151.50:8090` - там пишется `IQWork pin generator v.X.X` - если не видим, идем в докер и запускаем:
```
ssh root@192.168.151.50 #ключ ssh само собой ваш должен быть там прописан, проверка паролей там отключена, хоть и спрашивает.
sudo mc
Ctrl + o
cd /srv/config/pin-generator
docker ps #покажет какие контейнеры запущены, должен быть активным ubi_nginx
docker-compose up -d #запустит (наверное) контейнер
docker ps # проверяем, что запущен: 0.0.0.0:8090->80/tcp ubi_nginx
```

снова идем на `http://192.168.151.50:8090`, должны увидеть `IQWork pin generator v.X.X`
пробуем выдавать серты